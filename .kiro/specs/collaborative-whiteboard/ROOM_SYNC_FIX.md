# Исправление синхронизации между комнатами

## Проблема
При переходе между комнатами данные с доски смешивались:
- Заходишь в комнату А, рисуешь желтое солнце
- Переходишь в комнату Б, видишь черное солнце (цвет изменился)
- Рисуешь коричневое дерево в комнате Б
- Возвращаешься в комнату А, видишь желтое дерево (рисунок из Б появился в А)

## Причина
1. Firebase слушатели не останавливались при смене комнаты
2. Локальные данные (strokes) не очищались полностью
3. Canvas не очищался перед загрузкой новых данных
4. Старые экземпляры WhiteboardManager не уничтожались

## Исправления

### whiteboard.js
1. **open()** - Добавлена полная очистка перед открытием:
   - Останавливаем старые слушатели
   - Полностью очищаем canvas (clearRect + fillRect)
   - Очищаем все массивы данных

2. **close()** - Добавлена полная очистка при закрытии:
   - Уничтожаем DrawingEngine
   - Очищаем все локальные массивы

3. **startListening()** - Добавлена проверка комнаты:
   - Сохраняем currentRoomId при начале слушания
   - Проверяем roomId в каждом callback
   - Игнорируем события если комната изменилась

4. **loadExistingStrokes()** - Добавлена проверка комнаты:
   - Проверяем что мы все еще в той же комнате
   - Игнорируем данные если комната изменилась

5. **stopListening()** - Улучшена остановка слушателей:
   - Явно отключаем child_added и value слушатели

### app.js
1. **Открытие whiteboard** - Улучшена проверка смены комнаты:
   - Полностью уничтожаем старый whiteboard
   - Очищаем все данные перед созданием нового

2. **forceLeaveRoom()** - Добавлена полная очистка:
   - Останавливаем слушатели
   - Очищаем все массивы
   - Уничтожаем ссылку

## Тестирование

1. Откройте приложение в двух окнах
2. Войдите в комнату А в обоих окнах
3. Нарисуйте что-то в окне 1
4. Проверьте что рисунок появился в окне 2
5. Выйдите из комнаты А в окне 1
6. Войдите в комнату Б в окне 1
7. Нарисуйте что-то другое в окне 1
8. Проверьте что в комнате Б только новый рисунок
9. Вернитесь в комнату А в окне 1
10. Проверьте что в комнате А только старый рисунок

## Результат
Теперь каждая комната имеет свою независимую доску, данные не смешиваются при переходах между комнатами.
