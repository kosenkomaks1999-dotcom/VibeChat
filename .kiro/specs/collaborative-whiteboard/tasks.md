# Implementation Plan: Collaborative Whiteboard

- [x] 1. Создать базовую структуру и UI модального окна


  - Создать HTML разметку модального окна с Canvas 800x600
  - Добавить кнопку "Открыть доску" в интерфейс комнаты
  - Создать CSS стили для модального окна и toolbar
  - Добавить элементы управления (кнопки инструментов, цветов, размера)
  - _Requirements: 1.1, 1.2_




- [ ] 2. Реализовать класс WhiteboardManager
  - Создать файл `resources/app/src/modules/whiteboard.js`
  - Реализовать конструктор с инициализацией Canvas и context
  - Добавить методы `open()` и `close()` для управления модальным окном
  - Реализовать методы `setTool()`, `setColor()`, `setSize()`


  - Добавить обработчики событий для кнопок toolbar
  - _Requirements: 1.1, 2.5_

- [ ] 3. Реализовать DrawingEngine для рисования
- [ ] 3.1 Создать класс DrawingEngine
  - Реализовать обработчики событий мыши (mousedown, mousemove, mouseup)


  - Добавить поддержку touch событий для планшетов
  - Реализовать метод `startStroke()` для начала рисования
  - Реализовать метод `addPoint()` для добавления точек
  - Реализовать метод `endStroke()` для завершения штриха
  - _Requirements: 2.1, 2.2, 2.3, 7.2_


- [ ] 3.2 Реализовать отрисовку штрихов
  - Создать метод `drawStroke()` для отрисовки одного штриха
  - Реализовать метод `drawAllStrokes()` для отрисовки всех штрихов
  - Добавить метод `clearCanvas()` для очистки
  - Использовать `requestAnimationFrame` для плавной отрисовки
  - Оптимизировать отрисовку для производительности
  - _Requirements: 7.1, 7.3, 7.4_


- [x] 3.3 Реализовать инструменты рисования
  - ~~Реализовать инструмент "Карандаш" (pen) с тонкими линиями~~ (убран по запросу)
  - Реализовать инструмент "Маркер" (marker) с толстыми линиями ✅
  - Реализовать инструмент "Ластик" (eraser) с белым цветом ✅
  - Добавить визуальную обратную связь для выбранного инструмента ✅
  - _Requirements: 2.2, 2.3, 2.5_

- [x] 4. Реализовать FirebaseSync для синхронизации
- [x] 4.1 Создать класс FirebaseSync
  - Реализовать конструктор с подключением к Firebase
  - Создать структуру данных в Firebase: `rooms/{roomId}/whiteboard/strokes/`
  - Реализовать метод `publishStroke()` для отправки штриха
  - Добавить батчинг точек (группировка каждые 50-100мс) ✅
  - _Requirements: 3.1, 3.3_

- [ ] 4.2 Реализовать получение штрихов от других пользователей
  - Реализовать метод `onStrokeAdded()` с callback

  - Добавить слушатель Firebase для новых штрихов
  - Реализовать отрисовку полученных штрихов на Canvas
  - Добавить индикацию никнейма пользователя при рисовании
  - _Requirements: 3.2, 3.4_

- [x] 4.3 Реализовать управление штрихами
  - Реализовать метод `loadExistingStrokes()` для загрузки при открытии ✅
  - Реализовать метод `clearAllStrokes()` для очистки доски ✅
  - Добавить ограничение на 1000 штрихов с автоудалением старых ✅
  - Реализовать автоочистку при выходе последнего участника ✅
  - _Requirements: 1.3, 6.1, 6.2, 6.3_

- [x] 5. Реализовать отображение курсоров других пользователей

  - Создать структуру данных для курсоров: `rooms/{roomId}/whiteboard/cursors/`
  - Реализовать метод `publishCursor()` для отправки позиции
  - Добавить слушатель для курсоров других пользователей
  - Отрисовывать курсор с никнеймом пользователя
  - Удалять неактивные курсоры (>5 секунд)
  - _Requirements: 3.4_


- [ ] 6. Реализовать палитру цветов
  - Создать UI с 12 цветами (black, white, red, green, blue, yellow, orange, purple, pink, cyan, brown, gray)
  - Добавить обработчики клика для выбора цвета
  - Визуально выделять выбранный цвет
  - Применять выбранный цвет к новым штрихам

  - _Requirements: 2.4_

- [ ] 7. Реализовать слайдер размера кисти
  - Создать HTML range input для размера (1-50)
  - Добавить отображение текущего значения
  - Обновлять размер кисти при изменении слайдера
  - Применять размер к инструментам (pen: 1-10, marker: 10-30, eraser: 10-50)
  - _Requirements: 2.1, 2.2, 2.3_

- [ ] 8. Реализовать функцию очистки доски
  - Добавить кнопку "Очистить доску"
  - Показывать диалог подтверждения при нажатии
  - При подтверждении удалять все штрихи из Firebase
  - Очищать Canvas у всех участников
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [ ] 9. Реализовать сохранение доски как PNG
  - Добавить кнопку "Сохранить как PNG"
  - Конвертировать Canvas в PNG с белым фоном
  - Генерировать имя файла с датой и временем
  - Автоматически скачивать файл через download link
  - _Requirements: 5.1, 5.2, 5.3, 5.4_




- [x] 10. Добавить обработку ошибок и edge cases
  - Добавить проверку поддержки Canvas в браузере ✅
  - Показывать индикатор "Reconnecting..." при потере соединения ✅
  - Буферизовать штрихи локально при отсутствии соединения ✅
  - Валидировать входные данные (координаты, цвет, размер) ✅
  - Добавить обработку ошибок Firebase ✅
  - _Requirements: 6.4_

- [x] 11. Оптимизировать производительность
  - Реализовать кэширование часто используемых штрихов
  - Добавить оптимизацию отрисовки для >500 штрихов ✅
  - Использовать `willReadFrequently: true` для Canvas context ✅
  - Оптимизировать батчинг точек для минимизации трафика ✅
  - Добавить мониторинг размера данных (лимит 500 КБ) ✅
  - _Requirements: 6.4, 7.1, 7.3, 7.4_

- [ ] 12. Интегрировать вайтборд в основное приложение
  - Добавить кнопку "Открыть доску" в UI комнаты
  - Инициализировать WhiteboardManager при входе в комнату
  - Очищать ресурсы при выходе из комнаты
  - Добавить обработчики событий для открытия/закрытия
  - Обновить Firebase rules для доступа к whiteboard
  - _Requirements: 1.1_

- [ ]* 13. Тестирование и отладка
  - Протестировать рисование всеми инструментами
  - Протестировать синхронизацию между 2-3 пользователями
  - Протестировать очистку доски
  - Протестировать сохранение PNG
  - Протестировать производительность с 500+ штрихами
  - Протестировать на разных разрешениях экрана
  - _Requirements: All_
